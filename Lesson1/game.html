<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pixel Chase with greenPixels</title>
<style>
    body {
        margin: 0;
        overflow: hidden;
        position: relative;
    }
    #gameCanvas {
        position: absolute;
        top: 0;
        left: 0;
        z-index: 0;
    }
    #playerGif {
        position: absolute;
        top: -50px;
        left: 0;
        z-index: 2;
		image-rendering: pixelated;
		image-rendering: -moz-crisp-edges;
		image-rendering: crisp-edges;
    }
    #enemyGif {
        position: absolute;
        top: 0;
        left: 0;
        z-index: 2;
		image-rendering: pixelated;
		image-rendering: -moz-crisp-edges;
		image-rendering: crisp-edges;
    }
    #topdownRoom {
        position: absolute;
        top: 0px;
        left: 0;
        z-index: 1;
		width:768px;
		height:512px;
		image-rendering: pixelated;
		image-rendering: -moz-crisp-edges;
		image-rendering: crisp-edges;
		opacity:1;
    }
    canvas {
        display: block;
        margin: 0 auto;
    }
</style>
</head>
<body>
<canvas id="gameCanvas" width="800" height="600"></canvas>
<img id="playerGif" src="player-south.png" alt="Player GIF">
<img id="enemyGif" src="enemy-south.png" alt="Enemy GIF">
<img id="topdownRoom" src="mapart.png" alt="Top Down Room">

<script>
	var game_over = false;

    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
	
	const playerGif = document.getElementById("playerGif");
	const enemyGif = document.getElementById("enemyGif");

    const character = {
        width: 16,
        height: 32,
    };

    const player = {
        x: 300,
        y: 300,
        width: 16,
        height: 32,
        speed: 3,
        dx: 0,
        dy: 0,
        prevDx: 0,
        prevDy: 0
    };

    const enemy = {
        x: canvas.width - 300,
        y: canvas.height - 300,
        width: 16,
        height: 32,
        speed: 1,
        dx: 0,
        dy: 0,
        prevDx: 0,
        prevDy: 0
    };
	
    const yellowPixels = [];

    const img = new Image();
    img.src = 'map.png'; // Provide the path to your image here

    img.onload = function() {
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        detectYellowPixels();
		gameLoop();
    };

    function detectYellowPixels() {
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imageData.data;
		//console.log("yellow pixels start");

        for (let i = 0; i < data.length; i += 128) {
            const red = data[i];
            const green = data[i + 1];
            const blue = data[i + 2];
			
			//console.log("inini red:"+red+ " green:"+green + "blue:"+blue);

            if (red === 255 && green === 255 && blue === 0) {
                const x = (i / 4) % canvas.width + 32;
                const y = Math.floor(i / 4 / canvas.width) + 32;
				
				let yellowPixel = {
					x: x,
					y: y,
					width: 32,
					height: 32
				};
				
                yellowPixels.push(yellowPixel);
            }
        }
    }

    const greenPixels = []; // Array to store greenPixel coordinates

    const greenPixelsCount = 0; // Number of greenPixels

    // Generate random greenPixels
    for (let i = 0; i < greenPixelsCount; i++) {
        let greenPixel = {
            x: Math.floor(Math.random() * (canvas.width - 20)) + 10,
            y: Math.floor(Math.random() * (canvas.height - 20)) + 10,
            width: Math.floor(Math.random() * 16) + 16,
            height: Math.floor(Math.random() * 16) + 16
        };
        greenPixels.push(greenPixel);
    }

    function drawPlayer() {
        ctx.fillStyle = "rgba(0, 0, 0, 0)" // "blue"; // Adjust the alpha value (last parameter) for transparency
        ctx.fillRect(player.x, player.y, player.width, player.height);
    }

    function drawEnemy() {
        ctx.fillStyle = "rgba(0, 0, 0, 0)"  // "red";
        ctx.fillRect(enemy.x, enemy.y, enemy.width, enemy.height);
    }
	
    function drawYellowPixels() {
        ctx.fillStyle = "yellow";
        yellowPixels.forEach(yellowPixel => {
            ctx.fillRect(yellowPixel.x, yellowPixel.y, yellowPixel.width, yellowPixel.height);
        });
    }

    function drawGreenPixels() {
        ctx.fillStyle = "green";
        greenPixels.forEach(greenPixel => {
            ctx.fillRect(greenPixel.x, greenPixel.y, greenPixel.width, greenPixel.height);
        });
    }

    function clearCanvas() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    function movePlayer() {
        player.x += player.dx;
        player.y += player.dy;

        // Check collision with greenPixels
        if (checkGreenCollision(player.x, player.y, player.width, player.height)) {
            player.x -= player.dx;
            player.y -= player.dy;
            player.dx = 0;
            player.dy = 0;
        }
		
        // Check collision with yellow pixels
        if (checkYellowCollision(player.x, player.y, player.width, player.height)) {
            player.x -= player.dx;
            player.y -= player.dy;
            player.dx = 0;
            player.dy = 0;
        }
		
		// Update position of the player GIF
        playerGif.style.left = player.x + "px";
        playerGif.style.top = player.y + "px";
		
        // Update player GIF based on movement direction
        if (player.dx > 0 && player.dx !== player.prevDx) {
            playerGif.src = "player-east.png";
            player.prevDx = player.dx;
            player.prevDy = 0;
        } else if (player.dx < 0 && player.dx !== player.prevDx) {
            playerGif.src = "player-west.png";
            player.prevDx = player.dx;
            player.prevDy = 0;
        } else if (player.dy > 0 && player.dy !== player.prevDy) {
            playerGif.src = "player-south.png";
            player.prevDy = player.dy;
            player.prevDx = 0;
        } else if (player.dy < 0 && player.dy !== player.prevDy) {
            playerGif.src = "player-north.png";
            player.prevDy = player.dy;
            player.prevDx = 0;
        }
    }

    function moveEnemy() {
        // Simple chase algorithm
        if (enemy.x <= player.x) {
            if (!checkYellowCollision(enemy.x + enemy.speed, enemy.y, enemy.width, enemy.height) && !checkGreenCollision(enemy.x + enemy.speed, enemy.y, enemy.width, enemy.height)) {
                enemy.x += enemy.speed;
            }
        } else {
            if (!checkYellowCollision(enemy.x - enemy.speed, enemy.y, enemy.width, enemy.height) && !checkGreenCollision(enemy.x - enemy.speed, enemy.y, enemy.width, enemy.height)) {
                enemy.x -= enemy.speed;
            }
        }

        if (enemy.y <= player.y) {
            if (!checkYellowCollision(enemy.x, enemy.y + enemy.speed, enemy.width, enemy.height) && !checkGreenCollision(enemy.x, enemy.y + enemy.speed, enemy.width, enemy.height)) {
                enemy.y += enemy.speed;
            }
        } else {
            if (!checkYellowCollision(enemy.x, enemy.y - enemy.speed, enemy.width, enemy.height) && !checkGreenCollision(enemy.x, enemy.y - enemy.speed, enemy.width, enemy.height)) {
                enemy.y -= enemy.speed;
            }
        }
		
		// Update position of the enemy GIF
        enemyGif.style.left = enemy.x + "px";
        enemyGif.style.top = enemy.y + "px";
		
        if (enemy.dx > 0 && enemy.dx !== enemy.prevDx) {
            enemyGif.src = "enemy-east.png";
            enemy.prevDx = enemy.dx;
            enemy.prevDy = 0;
        } else if (enemy.dx < 0 && enemy.dx !== enemy.prevDx) {
            enemyGif.src = "enemy-west.png";
            enemy.prevDx = enemy.dx;
            enemy.prevDy = 0;
        } else if (enemy.dy > 0 && enemy.dy !== enemy.prevDy) {
            enemyGif.src = "enemy-south.png";
            enemy.prevDy = enemy.dy;
            enemy.prevDx = 0;
        } else if (enemy.dy < 0 && enemy.dy !== enemy.prevDy) {
            enemyGif.src = "enemy-north.png";
            enemy.prevDy = enemy.dy;
            enemy.prevDx = 0;
        }
    }

    function checkYellowCollision(x, y, width, height) {
        if (checkIsDotYellow(x, y) || checkIsDotYellow(x + width, y) || checkIsDotYellow(x, y + height) || checkIsDotYellow(x + width, y + height)) {
			return true;
		}
		return false;
    }
	
	function checkIsDotYellow(x, y) {
		const imageData = ctx.getImageData(x, y, 1, 1);
		const data = imageData.data;
		const red = data[0];
        const green = data[1];
        const blue = data[2];
        if (red === 255 && green === 255 && blue === 0) {
			return true;
		}
		return false;
	}

    function checkGreenCollision(x, y, width, height) {
        // Check collision with greenPixels
        for (let i = 0; i < greenPixels.length; i++) {
            if (
                x < greenPixels[i].x + greenPixels[i].width &&
                x + width > greenPixels[i].x &&
                y < greenPixels[i].y + greenPixels[i].height &&
                y + height > greenPixels[i].y
            ) {
                return true;
            }
        }

        // Check collision with canvas boundaries
        if (x < 0 || x + width > canvas.width || y < 0 || y + height > canvas.height) {
            return true;
        }

        return false;
    }

    function checkPlayerEnemyCollision() {
        if (
            player.x < enemy.x + enemy.width &&
            player.x + player.width > enemy.x &&
            player.y < enemy.y + enemy.height &&
            player.y + player.height > enemy.y
        ) {
			game_over = true;
            alert("Game Over!");
            // You can add game over logic here
        }
    }

    function gameLoop() {
		if (game_over == false) {
			//clearCanvas();
			// drawGreenPixels();
			drawPlayer();
			drawEnemy();
			movePlayer();
			moveEnemy();
			checkPlayerEnemyCollision();
			requestAnimationFrame(gameLoop);
		}
    }

    document.addEventListener("keydown", function (event) {
        switch (event.key) {
            case "w":
                player.dy = -player.speed;
                break;
            case "a":
                player.dx = -player.speed;
                break;
            case "s":
                player.dy = player.speed;
                break;
            case "d":
                player.dx = player.speed;
                break;
        }
    });

    document.addEventListener("keyup", function (event) {
        switch (event.key) {
            case "w":
            case "s":
                player.dy = 0;
                break;
            case "a":
            case "d":
                player.dx = 0;
                break;
        }
    });
</script>
</body>
</html>
